
hooks:
  rr: |
    my @AA;
    for my $A ($O->tractors) {
        if (w $A arr_if) {
            push @AA, $A->spawn();
        }
    }
    
    if (!@AA) {
        die "No traction for! ".ki($ar);
    }
    
    die "CROWD OF TRACTORS" if @AA > 1;
    for my $A (@AA) {
        $A->{B} = { %$ar };
        if (my $B_ = w $A B_) {
            $A->{B}->{_} = $B_;
        }
    }
    
    for my $A (@AA) {
        if (my $Already = w retract[$A]) {
            $Already->{B} = $A->{B};
            $A = $Already;
            say "A retracted     $O->{name}\t".ki($ar);
            $G->Flab("retracted  ", $ar);
            w $A nonfirst_times;
        }
        else {
            $A = $A->spawn;
            say "A               $O->{name}\t".ki($ar);
            $G->Flab("First time for  ", $ar);
            w $A first_time;
            w populi[$A];
            $A->{waystack} = $G->stackway;
        }
        $O->{t} = $A;
    }
    
    $G->Flab(AA => [@AA]);
    
    return @AA    ;
  retract: |
    my @keep;
    my @found;
    for my $line (@{ $O->W->{script} }) {
        #$H->info("Line: $line", $O->{name}, $line);
        next if ref $line eq "ARRAY" && @$line == 0; # wtf case
        if ($line->{t}->{B}->{_} eq $A->{B}->{_}) { # ar this to W->{G}?
             push @found, $line;
        }
        else {
            push @keep, $line;
        }
    }
    $O->W->{script} = \@keep;
    if (!@found) {
        $G->Flab("No foundo");
        return;
    }
    return $found[0]->{t};
  populi: |
    $G->unrush('populi') || return;
    # TODO enforce $A->{max_populi} (H/mess)
    my ($A) = $O->tractors;
    my $max = $A->{max_populi} || return;
    my $s = $O->W->{script};
    if (@$s > $max) {
        @$s = (reverse @$s)[0..$max];
    }
  random: |
    my $tot = @{ $O->W->{script} }-1;
    my $i = int rand $tot;
    return $O->W->{script}->[$i]->{t};
  find: |
    my @wheres;
    while (my ($k, $v) = each %$ar) {
        push @wheres, [ $k, $v ];
    }
    for my $line (@{ $O->W->{script} }) {
        #$H->info("Line: $line", $O->{name}, $line);
        next if ref $line eq "ARRAY" && @$line == 0; # wtf case
        my $A = $line->{t};
        return $A if @wheres == grep {
            !exists $A->{B}->{$_->[0]} ||
                $A->{B}->{$_->[0]} eq $_->[1]  } @wheres
    }

