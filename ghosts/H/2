hooks:
  in: |
    w hostinfo;
    $H->pub("H/H.style/H.name/H.id" => $$);
    Mojo::IOLoop->recurring(8 => sub {
        w hostinfo;
    });
    Mojo::IOLoop->recurring(2 => sub {
        H.r->set("H/H.style/H.name/H.id" => $H->hitime); # TODO lots
    });
  hostinfo: |
    my @ps = `ps -p$$ fu`;
    my ($u, $pid, $mem, $cpu) = (split /\s+/, $ps[1])[0,1,2,3];
    $_ = $_ / 100 for $cpu, $mem;
    my $tot
    #= ((`wc -l ghosts/*/*`)[-1]  =~ /(\d+) total/)[0]
    ;
    my $info = "$tot $cpu $mem ".$H->hitime;
    saygr $info if rand(5) > 4;
    $H->pub("hostinfo/H.style/H.name/H.id" => $info, 'ig');
    G.hostinfo_waits++;
    if (G.hostinfo_waits > 1) {
        sayre "hostinfo uncollected";
    }
      
  S:
    hostinfo:
      ack: |
        my (@s) = split /\s+/, $m;
        if (rand(5) > 1) {
            my $lag = (1000*sprintf('%.3f',$H->hitime - $s[-1])).'ms';
            sayyl "out there! lag: $lag";
        }
        G.hostinfo_waits = 0;

