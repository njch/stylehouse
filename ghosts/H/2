hooks:
  in: |
    w hostinfo;
    $H->pub("H/H.style/H.name/H.id" => $$);
    $G->recur(8 => sub {
        w hostinfo;
    });
    $G->recur(2 => sub {
        H.r->set("H/H.style/H.name/H.id" => $H->hitime); # TODO lots
    });
  hostinfo: |
    my @ps = `ps -p$$ fu`;
    my ($u, $pid, $mem, $cpu) = (split /\s+/, $ps[1])[0,1,2,3];
    $_ = $_ / 100 for $cpu, $mem;
    
    my $info = "$cpu $mem ".$H->hitime;
    
    saygr "hostinfo: $info " if rand(1) > 0.7;
    $H->pub("hostinfo/H.style/H.name/H.id" => $info, 'ig');
    
    G.hostinfo_waits++;
    if (G.hostinfo_waits > 1) {
        sayre "hostinfo uncollected";
    }
      
  S:
    hostinfo:
      ack: |
        my (@s) = split /\s+/, $m;
        if (rand(1) > 0.7) {
            my $lag = (1000*sprintf('%.3f',$H->hitime - $s[-1])).'ms';
            sayyl "out there! lag: $lag";
        }
        G.hostinfo_waits = 0;

