
hooks:
  fresh_init: |
    say "     H Fresh init H.style H.name";

    H._future = 1;
    push @{G.GGs||=[]}, $G; # H self
    
    H.r = w enRedis;
    
    H.pg = Mojo::Pg->new('postgresql://s@/s');
    H.db = H.pg->db;
    
    H.db->on(notification => sub {
        my ($db,$name,$pid,$payload) = @_;
        my $d = {};
        (d.top, d.m) = map { $H->fixutf8($_) } $name, $payload;
        for my $cb (@{H.subscr->{$name}}) {
            $G->timer(0.00001, sub { $cb->($d); });
        }
    });
    
    w figure_port;
    
    my $reS = sub { my $a = shift; w reS(%$a); }; 
    $G->su(S => $reS);
    $G->su("S/H.style/H.name" => $reS);
    $G->su("S/H.style/H.name/H.id" => $reS);
    
    w in_listenings;
    # S/* mods ^
    
    $G->timer(60*9+(20 * rand 4),
        sub { sayre "voluntary reexec" for 1..13; w reexec; })
        if H.name !~ /Z/;
    
    
    $G->recur(5 => sub { H.r->ping || die "not redis?" });
    
    
    # start git torrent
    # do it all
    # $0 has become a runtime
    w pre_in;
    w in;
    waylay transam; # 3
  figure_port: |
    my $listen = readlink('listen');
    my ($host,$port, $wa) = split ':', $listen;
    die "too much listen" if $wa;
    ($port, $host) = (2000, undef) if !$port && $host =~ /^\d+$/;
    $port ||= 2000;
    $host ||= '127.0.0.1';

    $port += ord(H.name) + 8000;
    
    H.listen_http = "http://$host:$port";   
    H.listen_ws = "ws://$host:$port/s";
    
  subsc: |
    my $tos = H.subscr->{$top} ||= [];
    push @$tos, $cb;
    
    H.db->listen($top);
    
    sayyl "Subbed to $top";
  enRedis: |
    my $r = Redis->new(
        server => 'localhost:8888',
        reconnect => 1,
        every => 10000,
    );
    r.gest = sub {
        my ($k, $make) = @_;
        my $c = H.r->get($k);
        return ref \$c eq "SCALAR" ? $H->fixutf8($c) : $c if $c;
        $c = $make->();
        H.r->set($k => $c);
        return $c;
    };
    $r
  reexec: |
        for my $E (@{H.who||[]}) {
            w $E disconecktie;
        }
        sayre "finish!";
        exec "nice perl $0 @ARGV";
  S:
    reexec: w reexec;
    retile: w retile;
    
  retile: |
    my $g = G:S/O;
    $g || die "no S/O ghost!";
    $g w retile;
  

