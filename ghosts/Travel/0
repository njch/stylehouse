name: wormhole splatter
hooks:
  splat_wormhole: |
    say "Wormhole Splattur: $view->{divid}";
    say $wormhole->describe_size();
    $view->newtext($wormhole->{script}, {
        spatialise => sub { { left => 40, space => 30, top => 50 } },
        tuxts_to_htmls => sub {
            my $self = shift;
            $self->{tuxts} = [
            map {
                $_->{value} eq "nothing" ? $_
                : do {
                    my $line = $_->{value};
                    my $ghost = $line->{ghost};
                    my $ar = { texty => $self,
                               s => $_, tuxts => [] };
                    w $ghost chain_to_tuxts($ar);
                    @{$ar->{tuxts}};
                }
            } @{$self->{tuxts}}
            ];
        }
    });
    
  chain_to_tuxts: |
    my $line = $s->{value};
    $ar->{line} = $line;
    $s->{left} += $line->{depth} * 40;
    w tuxt_way_in($ar);
    w tuxt_ways_out($ar);
    w tuxt_etc($ar);
    w tuxt_this($ar);
    
  tuxt_way_in: |
    my $wins = { %$s };
    $wins->{id} .= "-wayin";
    my $wi = $line->{wayin};
    
    my $waydo = $wi ? w tuxt_a_waychain({ %$ar, chain => $wi }) : "! way in";
    $wins->{value} = "i<pre>".enc($waydo)."</pre>";
    
    $wins->{html} = 1;
    $wins->{style} .= colorf(!$wi ? $wi : $wi->{way});
    $wins->{top} -= 10;
    $wins->{left} += -20;
    $wins->{style} .= "font-size: 8pt; opacity:0.4;";
    push @{$ar->{tuxts}}, $wins;
    
  tuxt_ways_out: |
    my $wous = { %$s };
    $wous->{id} .= "-waysout";
    my $wo = $line->{wayout};
    
    my $waygo;
    if ($wo) {
        my @ways = map {
            w tuxt_a_waychain({ %$ar, chain => $_ })
         } @$wo;
        $waygo = join("\n.\n", @ways);
    }
    else {
        $waygo = "no out";
    }
    $wous->{value} = "o<pre>".enc($waygo)."</pre>";
    
    $wous->{html} = 1;
    $wous->{top} += 0;
    $wous->{left} += 330;
    $wous->{style} .= "font-size: 7pt; opacity:0.4;";
    $wous->{class} .= "idly";
    
    push @{$ar->{tuxts}}, $wous;
    
  wdump: |
    use Data::Dumper;
    $Data::Dumper::Maxdepth = 2;
    return Dumper($in);
    
  tuxt_a_waychain: |
    $chain = { %$chain };
    my $as_from = delete $chain->{as_from};
    delete $chain->{way}; # TODO random hack
    my $l;
    if ($chain->{print}) {
        $l = $G->doo($chain->{print},
            {chain => $chain});
    }
    else {
        $l = join " }{ ",
            map { "$_: $chain->{$_}" }
            sort keys %$chain;
    }
    if ($as_from) {
        my $li = w tuxt_a_waychain({ %$ar, chain => $as_from });
        $l .= ind("  as_from: ", $li);
    }
    return $l
    
  tuxt_this: |
    my $this = { %$s };
    $this->{id} .= "-this";
    $this->{value} = $line->{thing};
    $this->{style} .= "color: #bb3564; font-size: 10pt; ".colorf($line->{thing})." opacity:0.4; padding: 0.4em; ";
    $this->{style} .= "border: 2px dotted red;" if ref $line->{thing};
    #$this->{top} -= 0;
    #$this->{left} += 50;
    push @{$ar->{tuxts}}, $this;

