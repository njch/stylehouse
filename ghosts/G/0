
name: Ghost
hooks:
  _load_ways_post: |
    $S->w("load_ways_post");
    my $lwc = $S->{load_ways_count};
    $G->Flab("$S->{name}        load ways count: $lwc");
    $S->w("any_init");
    $lwc == 1 ?
        w _fresh_init(%$ar)
      : w _recoded_init(%$ar)
    
  _recoded_init: |
    $S->w("recoded_init");
    my $g = $S;
    while ($g->{O} && ref $g->{O} eq "Ghost") {
        $g->w("child_recoded_init", {S => $S}) if $g eq $S;
        $g = $g->{O};
        $g->w("any_child_recoded_init");
    }
  _fresh_init: |
    $S->w("fresh_init");
    
  sing: |
    $G->{singing} ||= {};
    return if $G->{singing}->{$name} && $G->{singing}->{$name}++; # ignore sing until...
    $G->Flab(" sing init $name");
    $G->{singing}->{$name} = 1;
    my $t = $ar->{block_for} || $ar->{again_after} || 0.04;
    my $d = $ar->{begin_after} || 0.01;
    $G->timer($d, sub {
        $G->timer($t, sub {
            my $splatter = delete $G->{singing}->{$name};
            if ($splatter > 1 && $ar->{again_after}) {
                $G->Flab("Sig reps $splatter... "
                    .($ar->{again_after} ? "again!" : ".")
                    ."  $name");
                w sing(%$ar);
            }
        }, "sing-block        $name");
        $G->{singing}->{$name} = 1;
        $code->();
    }, "pre-sing     $name");
    
    

