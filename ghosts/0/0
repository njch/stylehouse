
name: other stuff...
hooks:
  try: |
    Say 'Restarting S';
    my $pm = ".pm";
    `touch l/S$pm`;
    
  any_init: |
      $G->timer(0.2,sub{waylay code;}); 
  fresh_init: |
    push @{G0.recoded_cbs}, sub { w try; };
  code: |
    my @ched;
    Say "Cioding 0";
    for my $w ($G->anyway('0')) {
        my ($nb, $co) = %$w;
        
        #die sw['etc',$co, $nb] unless ref $co eq "ARRAY";
        
        next unless $co;
        my @code = (
            join "\n",
            "package $nb;", 
            "our \$H;",
            map { "use $_;" }
                "strict", "warnings", "utf8", "lib 'lib'", "feature 'say'"
        );
        my $btw = {};
        for my $ch (@$co) {
            say "skipping a blank K in $nb" && next if !ch.K;
            
            my $D = ch.D || ch.SD;
            $D = $G->parse_babble($D) unless ch.style =~ /nonbabble/;
            
            if (ch.K eq "head" || ch.K eq "everything") {
                if (ch.K eq "everything") {
                    @code = ();
                }
                ch.style .= "bare";
                if (my $lg = ch.libglob) {
                    my @l = map { /\/(.+?)\.pm$/ } glob $lg;
                    my ($l) = $lg =~ /^(.+)\/.+?$/;
                    push @code, "use lib '$l';";
                    push @code, "use $_;" for grep {$_ ne 'S'} @l;
                    btw.s.___LIBGLOBETC = join "\n",
                        map { "\$${_}::H = \$H;" } @l;
                }
            }
            
            if (ch.style !~ /bare/) {
                $D =~ s/$_/btw.s->{$_}/seg for keys %{btw.s};
                
                # setup self
                $D = "my \$$nb = shift;\n$D" if ch.style !~ /func/;
                
                # return self
                $D = "$D\n\$$nb"             if ch.K eq "new" || ch.SD;
                
                $D = ind('    ', $D);
                $D =~  s/^    $//sgm;
                $D = "sub ch.K {\n$D\n}\n";
            }
            push @code, $D;
        }
        push @code, ($co->[0]->{K} ne "everything" ? "'stylehouse'" : ''); ##
        my $file = "l/${nb}.pm";
        write_file($file, join("\n", @code));
        push @ched, $file;
    }
    run "perl -c l/H*";
    
    waylay try unless grep {$_ =~ /^l\/S\.pm/} @ched;

