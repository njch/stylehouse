name: Styluxyio
dials:
  max_depth: 7
  form: 42
chains:
 - K: xW #c
   dom_depth: 0
   arr_if: |
     ref $thing eq "Wormhole";
   B_: |
     $thing
   foreach_travel:
     each: grep { $_->{depth} == 0 } @{$thing->{script}}
   print: |
     ".$Li->{n}"
 
 - K: xL
   iK: xW|xL
   arr_if: |
     ref $thing eq "HASH"
     && ref $thing->{o} eq "ARRAY"
   print: |
     ".$Li->{n}"
   foreach_travel:
     each: grep { defined $_ } map { $_->{B}->{Li} } @{$thing->{o}};
hooks:
  event: |
    my $xL = $L;
    my $yL = $xL->{t};
    my $yiw = $yL->{i};
    my $yt = $yL->{t};
    Say "Clicked on  ".pint($yiw)."\t\t".$yt;
    if ($yiw->{K} eq "Thing") {
        my $nothing = $yt;
        $O Tw arr[$nothing];
    }
  html: |
        my $c = w.B.x;
        my $attr = {};
        my @style = ();
        my @class = ();
        for my $a (qw{id}) {
            $attr->{$a} = $c->{$a} if exists $c->{$a};
        }
        for my $a (qw{height width left top}) {
            if (exists $c->{$a}) {
                my $v = $c->{$a};
                $v = ($v * 100).'%' if $v !~ /em$/;
                push @style, "$a:$v"; 
            }
        }
        if (c.height =~ /em$/ && c.width == 1) {
            push @style, "float:left";
        }
        if (exists c.left || exists c.top) {
            push @style, "position:absolute";
        }
        if (c.class) {
            push @class, @{c.class};
        }
        if (c.style) {
            for my $styley (@{c.style}) {
                my $styles = [ flatline($styley) ];
                push @style, @$styles;
            }
        }
        #$attr->{title} = $tw->{B}->{Lo}->{depth}." ".pint($tw)." ~ ".pint($tw->BLi->{t}->{i});
         
        my $tag = c.tag || "te";
        if (!defined w.B.Lo) {
            $tag = "wormhole";
            my $W = $G->W;
            attr.title = G.name;
            (attr.id) = W.id =~ /-(\w+)$/;
        }
        
        my $content = c.content if defined c.content;
        $content = join "\n", @{c.conty} if c.conty;
        
        attr.style = join "; ", @style if @style;
        attr.class = join " ", @class if @class;
        
        return "<$tag ".join(" ", map {"$_=\"$attr->{$_}\""} sort keys %$attr).">"
        ."\n".ind("  ", $content)."\n"."</$tag>\n"
    
    
    
    
    # etc
    
        
    
  T_end: |
    push @{G.Torail||=[]}, $L;
    if (G.depth == 0) {
        my $html = w next_phase;
        @$r = ($html);
    }
        
  next_phase: |
      for my $L (@{G.Torail}) {
            w style_to_x[$L];
      }
      for my $L (@{G.Torail}) {
            w x_to_h[$L];
      }
      return G.i.B.x.conty;
      Say $html;
      
  x_to_h: |
    my $x = L.i.B.x;
    for my $w (@{L.o}) {
        push @{ x.conty ||= [] }, w html[$w];
        #font-size-adjust: 0.58;
    }
  style_to_x: |
    my $x = L.i.B.x = {};
    my $yL = L.t;
    my $got = {
    l => [ grep { !_.B.Li } @{yL.o} ],
    t => [ grep { _.B.Li } @{yL.o} ],
    i => [ @{yL.i} ],
    };
    my $hg = sub {
        my ($what, $order) = @_;
        my @R;
        for my $yg (split '', $order) {
            for my $w (@{$got->{$yg}}) {
                if (w.B && w.B.s) {
                    if (exists w.B.s->{$what}) {
                        push @R, w.B.s->{$what}
                    }
                    if (exists w.B.s->{$what."_D"}) {
                        push @R, $G->w("B/s/$what", {}, $w)
                    }
                }
            }
        }
        @R
    };
    
    
    my @content = $hg->(content => 'li');
    @content > 1             && die "cont > 1";
    @content && @{got.t}     && die "cont & t";
    ($x->{content}) = @content if @content;
    
    $x->{class} = [ flatline($hg->(class => 'li')) ];
    $x->{style} = [ flatline($hg->(style => 'il')) ];
    $x->{tag} = [ flatline($hg->(tag => 'il')) ];
    
    my @div = $hg->(div => 'li');
    @div > 1                 && die "div > 1";
    if (@div) {
        my ($v) = @div;
        my $vi = {};
        ($vi->{width},$vi->{height}) = split "x", $v; $v =~/^x/&&die"?";
        while (my ($iv, $parts) = each %$vi) {
            if (!$parts) {
                next;
            }
            my $inc;
            if ($parts =~ /em$/) {
                $inc = $parts;
                $parts = 1;
            }
            $parts = 0+@{ L.o }    if $parts eq "...";
            $parts = 1    if $parts == 0;
            $inc ||= sprintf("%.3f", 1 / $parts);
            my $side = $iv eq "width" ? "left" : "top";
            my $i = 0;
            
            for my $w (@{ L.o }) {
                die "lower w.B.x not yet" unless w.B.x;
                my $ox = w.B.x ||= {};
                if ($parts == 1) {
                    $ox->{$iv} = $inc;
                }
                else {
                    $ox->{$side} = $i;
                    $i += $inc;
                    $ox->{$iv} = $inc;
                }
            }
        }
    }
    
    
  diagontrail: |
    my $htalk = "";
    while (my ($attr, $hh) = each %$h) {
        $htalk .= join("\n", "$attr:", map{"  ".ki($_)} @$hh)."\n";
    }
    my $xt = join "", map { "$_\n" } @{$x->{children}};
    $xt .= "  $_:$x->{$_}" for grep { $_ ne 'children'} keys %$x;
    my $diag = {
       #"an thing" => ghostlyprinty($yL->{t}),
        "D" => join("",("DDDD")x$yL->{depth}), 
        h => $htalk,
        x => $xt,
        X => $xiw->{B}->{s}->{x}, 
    };
    
    my $ytalk = "!html ";
    for my $ya (['l',$ylw],['t',$ytw],['i',[$yiw]]) {
        my ($y,$yww) = @$ya;
        $ytalk .= join "", map {
            "$y ".
            (ref $_ eq "Way" ?
            ($_->pint.'<t style="color:white;">'.ki($_->{B} ? $_->{B}->{s} : {}).'</t>')
            : "iww!www: $_")."\n"
        } @$yww
    }
    $diag->{ytalk} = $ytalk;
    push @{ $G->{_trail} }, $diag;
   

