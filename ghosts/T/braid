name: spiral braid
hooks:
  recoded_init: |
    H.G->w('re/exec');
  any_init: |
  
    G.U ||= {};

    
    
    
  DooB: |
    my $B = 0->sway({CsK => 'B', K => $K}) || die "noK $K";
    delete ar.K;
    B.ar = $ar if %$ar;
    for my $d (qw'B Y') {
        my $E = 0->EgyB($B->{$d});
        $B->{$d.'o'} = [ map {
            # 0.6666* => Y => 6/9
            { $_ => { $d => $E->{$_} } }
        } sort keys %$E ];
    }
    
    0->visTp({
        B => $B,
        r => { noo => 1 },
    }, "Fun");
    T.B = $B; # not mergey this one time
    die "BB BB" if T.B ne $B;
    B.top = $T;
    
    
    Say "BRRRRRRRRRAID! $K $K $K";
    
    B.Boi = 0;
    my $s;
    while (defined( my $s = T.B.Bo->[ T.B.Boi ] )) {
        (T.B.Bangle, my $B_K) = %$s;
        (my $_B, T.B.BK) = %$B_K;
        $_B eq "B" || die "noB";
        w anTop[$B];
        T.B.Boi++;
    }
  anTop: |
    my $ds = 0->Tind();
    saybl "$ds anTop i->".ar.i.K if ar.i;
    saybl "$ds anTop B->".ar.B.Bangle if ar.B;
    0->visTp($ar, "Fun") if ar.i; # not if B, loses...
    T.B = ar.B if ar.B;
    
    my $B = T.B;
    my ($for, $aft) = ([], []);
    my @Ds = ($for, {'B' => T.B.BK}, $aft);
    for my $s (@{ T.B.Yo||[] }) {
        (my $Yangle, my $Y_K) = %$s;
        
        my $to = $Yangle > B.Bangle ? $aft : $for;
        
        push @$to, $Y_K; # {Y => $YK}
    }
    
    my $s = "  >";
    for my $D (flatline(@Ds)) {
        (my $d, my $K) = %$D;
        
        my $_s = $s;
        $_s = " - " if $d eq "Y";
        $_s = " - $ds  $_s  B.K-$d-$K T.i.K";
        #sayyl($_s) if $d eq "Y";
        saybl($_s) if $d eq "B";
        $s = "<  " if $d eq "Y";
        
        my $D = $B->{$d}->{$K};
        $G->doo($D, {
            %{B.ar||{}}, ar=>B.ar,
            d=>$d,K=>$K,TiK=>T.i.K,
        });
    }

